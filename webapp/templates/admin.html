<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cropmarker Web - Admin</title>
  <link rel="stylesheet" href="/static/app.css" />
</head>
<body>
  <div class="topbar">
    <div class="muted">Admin panel</div>
    <div class="muted">You can close this tab when done.</div>
  </div>

  <div class="container adminWide">
    <h1>Annotators</h1>

    {% if message %}
      <div class="card adminMessage">
        <strong>{{ message }}</strong>
        {% if token_to_copy %}
          <div class="adminTokenBox">
            <div class="muted">Copy this token and send by email:</div>
            <div class="adminToken">{{ token_to_copy }}</div>
          </div>
        {% endif %}
      </div>
    {% endif %}

    <div class="card">
      <h2>Create annotator</h2>
      <form method="post" action="/admin/users/create" class="adminForm">
        <input type="hidden" name="token" value="{{ admin_token }}" />
        <div class="adminGrid">
          <label>Username
            <input type="text" name="username" required />
          </label>
          <label>Expertise
            <select name="expertise_score" required>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="3">3</option>
              <option value="5">5</option>
            </select>
          </label>
          <label>Access Token
            <div class="adminTokenRow">
              <input id="createToken" type="text" name="access_token" readonly placeholder="Click Generate" />
              <button type="button" class="secondary" onclick="generateCreateToken()">Generate</button>
            </div>
            <div class="muted" style="margin-top:6px;">8 characters (A–Z, a–z, 0–9)</div>
          </label>
        </div>
        <button type="submit">Create</button>
      </form>
    </div>

    <div class="card">
      <div class="adminTableWrap">
        <table class="adminTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Expertise</th>
              <th>Token</th>
              <th>Runtime</th>
              <th>Done</th>
              <th>Total</th>
              <th>Remaining</th>
              <th>Last login (UTC)</th>
              <th>Last save (UTC)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
              <tr>
                <td><strong>{{ u.username }}</strong></td>
                <td>{{ u.expertise_score }}</td>
                <td><span class="adminTokenCell">{{ u.token or '' }}</span></td>
                <td>{{ u.runtime or '' }}</td>
                <td>{{ u.done }}</td>
                <td>{{ u.total }}</td>
                <td>{{ u.remaining }}</td>
                <td>{{ u.last_login_at or '' }}</td>
                <td>{{ u.last_saved_at or '' }}</td>
                <td class="adminActions">
                  <form method="post" action="/admin/users/update" class="adminInline">
                    <input type="hidden" name="token" value="{{ admin_token }}" />
                    <input type="hidden" name="username" value="{{ u.username }}" />
                    <select name="expertise_score" aria-label="expertise">
                      <option value="0" {% if u.expertise_score == 0 %}selected{% endif %}>0</option>
                      <option value="1" {% if u.expertise_score == 1 %}selected{% endif %}>1</option>
                      <option value="3" {% if u.expertise_score == 3 %}selected{% endif %}>3</option>
                      <option value="5" {% if u.expertise_score == 5 %}selected{% endif %}>5</option>
                    </select>
                    <button type="submit" class="secondary">Update</button>
                  </form>

                  <form method="post" action="/admin/users/rotate-token" class="adminInline">
                    <input type="hidden" name="token" value="{{ admin_token }}" />
                    <input type="hidden" name="username" value="{{ u.username }}" />
                    <button type="submit" class="secondary">Rotate token</button>
                  </form>

                  <form method="post" action="/admin/users/reset" class="adminInline" onsubmit="return confirm('Delete ALL annotations for this user?');">
                    <input type="hidden" name="token" value="{{ admin_token }}" />
                    <input type="hidden" name="username" value="{{ u.username }}" />
                    <button type="submit" class="secondary">Reset</button>
                  </form>

                  <form method="post" action="/admin/users/delete" class="adminInline" onsubmit="return confirm('Delete this user AND all their data?');">
                    <input type="hidden" name="token" value="{{ admin_token }}" />
                    <input type="hidden" name="username" value="{{ u.username }}" />
                    <button type="submit" class="danger">Delete</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="hint">
      <p>Admin access is controlled by your admin token. Keep it secret.</p>
    </div>
  </div>

  <script>
    function _randomAlnum(len) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      if (window.crypto && window.crypto.getRandomValues) {
        const buf = new Uint32Array(len);
        window.crypto.getRandomValues(buf);
        let out = '';
        for (let i = 0; i < len; i++) {
          out += chars.charAt(buf[i] % chars.length);
        }
        return out;
      }
      let out = '';
      for (let i = 0; i < len; i++) {
        out += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return out;
    }

    function generateCreateToken() {
      const el = document.getElementById('createToken');
      if (!el) return;
      el.value = _randomAlnum(8);
    }
  </script>
</body>
</html>
