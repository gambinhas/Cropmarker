<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cropmarker Web - Before you start</title>
  <link rel="stylesheet" href="/static/app.css" />
</head>
<body>
  <div class="container">
    <h1>Cropmarker Web</h1>
    <p class="muted">Annotator: <strong>{{ username }}</strong></p>

    <div class="card introCard">
      <h2>Before you start</h2>
      <p class="muted">Please read the summary below. When you are ready, click “Start annotating”.</p>

      <div class="introImageWrap">
        <img class="introImage" src="/resources/cropmark.png?v=2" alt="Before you start summary" />
      </div>

      <form method="get" action="/tasks/next" class="introActions">
        <button type="submit" class="big">Start annotating</button>
      </form>
    </div>
  </div>
  <script>
(() => {
  // Hidden runtime tracker: counts only while this page is open/visible.
  const PING_INTERVAL_MS = 15000;
  let pingTimer = null;

  async function pingRuntime(keepalive=false) {
    try {
      await fetch('/api/runtime/ping', {
        method: 'POST',
        credentials: 'same-origin',
        keepalive: !!keepalive,
        headers: { 'Content-Type': 'application/json' },
        body: '{}'
      });
    } catch (e) {
      // ignore
    }
  }

  function startPings() {
    if (pingTimer) return;
    pingRuntime(false);
    pingTimer = setInterval(() => pingRuntime(false), PING_INTERVAL_MS);
  }

  function stopPings() {
    if (!pingTimer) return;
    clearInterval(pingTimer);
    pingTimer = null;
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) stopPings();
    else startPings();
  });

  window.addEventListener('beforeunload', () => {
    pingRuntime(true);
  });

  if (!document.hidden) startPings();
})();
  </script>
</body>
</html>
