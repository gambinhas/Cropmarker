Cropmarker WebApp — Como grava e como exportar (admin)
Data: 2026-01-12

1) Como a webapp grava (passo a passo)

1.1 Login (username apenas)
- O anotador entra com um Access Token (único por utilizador), disponibilizado por email.
- A sessão fica guardada no browser via cookie de sessão.
- Não existem passwords.

1.2 Lista de tarefas por utilizador (420 itens)
- Na primeira utilização de um username, o backend garante a lista de trabalho desse utilizador.
- É criada uma lista por utilizador (UserTask), com:
  - 381 tarefas originais
  - 39 duplicados QC
  - Total: 420
- A ordem é aleatória por utilizador (inclui originais e duplicados misturados).
- Duplicados QC são instâncias separadas (UserTask diferentes), podendo referenciar a mesma tarefa base.

1.3 Carregar uma tarefa para anotar (hidratação)
- Ao abrir uma tarefa, o backend carrega:
  - a instância do utilizador (UserTask)
  - a tarefa base (Task: site, filename, unique_id, rel_path)
  - e, se existir, a anotação já guardada (Annotation)
- Se já existir Annotation, o frontend pré-carrega:
  - classificação (cropmark)
  - desenho (drawing_json)
  - ajustes (brightness/contrast), se guardados

1.4 Guardar (Save & Next)
- Ao clicar “Save & Next”, o frontend envia para o backend:
  - cropmark (0/1/2)
  - drawing_json (desenho serializado; normalmente relevante apenas para 1/2)
  - brightness e contrast (opcional, se aplicável)
- O backend cria/atualiza uma linha na tabela Annotation para:
  - user_id
  - user_task_id
- As anotações ficam isoladas por utilizador.

1.5 Revisitar
- Ao voltar atrás/à frente, o backend volta a carregar a Annotation existente e o frontend mostra o estado guardado.


2) Como exportar (admin) para o formato desejado (XLSX)

Importante
- O export é feito via CLI (offline/admin). Não há botão de export na UI.
- Isto evita que anotadores façam export/download.

2.1 Onde está a base de dados
- Por defeito: webapp_data/webapp.sqlite3
- O CLI aceita: --db <caminho>

2.2 Ativar o ambiente certo
- Usa o ambiente/venv da webapp (não o do Label Studio).
- Alternativa prática: usa o script run_webapp.cmd para preparar o ambiente da webapp.

2.3 Exportar XLSX (um ficheiro por utilizador)
- A partir da pasta do repositório (Cropmarker), executar:
  python -m webapp.manage export-xlsx --out-dir export_xlsx

2.4 Exportar XLSX apenas para 1 utilizador
- Exemplo:
  python -m webapp.manage export-xlsx --username NOMEEXATO --out-dir export_xlsx

2.5 Exportar apontando explicitamente para a DB
- Exemplo:
  python -m webapp.manage --db webapp_data/webapp.sqlite3 export-xlsx --out-dir export_xlsx

2.6 Formato final do XLSX
- Nome do ficheiro:
  cropmarks_<username>_<expertise_score>.xlsx
- Colunas (ordem):
  Site, Date, Cropmark, Image, Saved, Drawing, QC_Reference, UniqueID, Order
- Regras:
  - Saved = “S” se existir anotação para o item; caso contrário vazio
  - Drawing = drawing_json (tipicamente só com Cropmark 1/2)
  - UniqueID = filename (compatível com a app de supervisão)
  - QC_Reference = filename original (apenas para duplicados QC)
  - Duplicados QC usam UniqueID = "<filename>_qc"
  - Order = display_order (ordem aleatória do utilizador)
  - Date = extraído do filename (ex: “aug2021” -> “08/2021”); se não for detetável fica vazio

2.7 Se faltar a dependência openpyxl
- O comando export-xlsx pode falhar se o openpyxl não estiver instalado no ambiente.
- Instalar com:
  pip install -r webapp/requirements.txt

2.8 Render (produção): descarregar XLSX via ZIP (admin, protegido por token)

Contexto
- No Render, os ficheiros gerados no disco (/var/data/...) não têm um botão de download direto.
- Para facilitar, existe um endpoint que devolve um ZIP com 1 XLSX por utilizador.
- Este endpoint NÃO aparece na UI e exige um token.

Configuração (Render)
- Definir env var: CROPMARKER_ADMIN_EXPORT_TOKEN
- Escolher um valor longo e aleatório.

Uso
- Abrir no browser (substituir <TOKEN>):
  https://<SEU_SERVICO_RENDER>/admin/exports.zip?token=<TOKEN>
- Resultado: download de "cropmarker_exports.zip" contendo "cropmarks_<username>_<expertise_score>.xlsx".

Notas
- Por defeito, exporta apenas utilizadores não-admin.
- Para exportar apenas 1 utilizador: adicionar "&username=NOMEEXATO".


Notas rápidas
- Export CSV “bruto” (já existe):
  python manage.py export-csv --out export.csv


3) Como criar utilizadores + Access Tokens (admin)

3.1 Criar um utilizador (gera token automaticamente)
- Executar na pasta do repositório:
  python -m webapp.manage create-user --username "NOME" --expertise-score 3
- O comando imprime:
  "Access token (send by email): ..."
- Copiar esse token e enviar por email ao anotador.

3.2 Criar um utilizador definindo o token manualmente
- Exemplo:
  python -m webapp.manage create-user --username "NOME" --expertise-score 5 --access-token "TOKEN_AQUI"

3.3 Rodar/alterar token de um utilizador existente
- Gerar automaticamente um novo token:
  python -m webapp.manage create-user --username "NOME" --rotate-token
- Ou definir explicitamente:
  python -m webapp.manage create-user --username "NOME" --access-token "NOVO_TOKEN"

Notas
- O token é guardado na DB apenas como hash (não é possível recuperá-lo depois).
- Se perderes o token, tens de rodar/gerar um novo e reenviar por email.
